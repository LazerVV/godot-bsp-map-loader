@@
-const LUMP_DRAWINDEXES = 12
-const LUMP_SURFACES = 13
+const LUMP_MESHVERTS = 11            #  int32 offsets
+const LUMP_EFFECTS   = 12
+const LUMP_SURFACES  = 13            #  a.k.a. “faces”

- var num_surfaces = lumps[LUMP_SURFACES].length / 68
+ const FACE_BYTES = 104
+ var num_surfaces = lumps[LUMP_SURFACES].length / FACE_BYTES
@@   # ---- read shader lump ----
- var shader_name = file.get_buffer(64).get_string_from_ascii()
+ var shader_name = file.get_buffer(64).get_string_from_ascii().split("\0")[0]
@@   # ---- read meshvert lump ----
+ var meshverts = []
+ file.seek(lumps[LUMP_MESHVERTS].offset)
+ var num_meshverts = lumps[LUMP_MESHVERTS].length / 4
+ for i in range(num_meshverts):
+     meshverts.append(file.get_32())
@@   # ---- surface read loop ----
- surf.first_index  = file.get_32()
- surf.num_indices  = file.get_32()
+ surf.first_meshvert = file.get_32()
+ surf.num_meshverts  = file.get_32()
@@   # always read patch size so we stay aligned
- if surf.surface_type == MST_PATCH:
-     surf.patch_width  = file.get_32()
-     surf.patch_height = file.get_32()
+ surf.patch_width  = file.get_32()
+ surf.patch_height = file.get_32()
@@   # ---- surface validation ----
- if surf.first_index >= num_indices or surf.first_index + surf.num_indices > num_indices or surf.num_indices < 0:
+ if surf.first_meshvert >= num_meshverts or surf.first_meshvert + surf.num_meshverts > num_meshverts or surf.num_meshverts < 0:
@@   # ---- geometry build ----
- for i in range(surf.num_indices):
-     var idx = indices[surf.first_index + i]
-     surf_indices.append(idx)
+ for i in range(0, surf.num_meshverts, 3):
+     var a = meshverts[surf.first_meshvert + i]
+     var b = meshverts[surf.first_meshvert + i + 1]
+     var c = meshverts[surf.first_meshvert + i + 2]
+     surf_indices.append_array([
+         surf.first_vert + a,
+         surf.first_vert + b,
+         surf.first_vert + c])

